<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taskhub Admin</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 56px; /* 为固定顶部导航栏留出空间 */
        }
        .scrollable-discussion {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
        }
        .message {
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .message:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .message-header {
            font-weight: bold;
            color: #0d6efd;
        }
        .message-time {
            font-size: 0.8rem;
            color: #6c757d;
        }
        .message-content {
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Taskhub Admin</a>
            
            <!-- 命名空间选择器 -->
            <div class="navbar-nav ms-auto">
                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle" type="button" id="namespaceDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        Namespace: <span id="currentNamespace">default</span>
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="namespaceDropdown" id="namespaceMenu">
                        <!-- 命名空间选项将通过JavaScript动态填充 -->
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <!-- 标签页导航 -->
                <ul class="nav nav-tabs" id="adminTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="discussion-tab" data-bs-toggle="tab" data-bs-target="#discussion" type="button" role="tab" aria-controls="discussion" aria-selected="true">Discussion</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="hunters-tab" data-bs-toggle="tab" data-bs-target="#hunters" type="button" role="tab" aria-controls="hunters" aria-selected="false">Hunters</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks" type="button" role="tab" aria-controls="tasks" aria-selected="false">Tasks</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="knowledge-tab" data-bs-toggle="tab" data-bs-target="#knowledge" type="button" role="tab" aria-controls="knowledge" aria-selected="false">Knowledge</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab" aria-controls="reports" aria-selected="false">Reports</button>
                    </li>
                </ul>

                <!-- 标签页内容 -->
                <div class="tab-content" id="adminTabContent">
                    <!-- 讨论区标签 -->
                    <div class="tab-pane fade show active" id="discussion" role="tabpanel" aria-labelledby="discussion-tab">
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">Discussion Forum</h5>
                                    </div>
                                    <div class="card-body">
                                        <!-- 消息历史区 -->
                                        <div class="scrollable-discussion mb-3" id="discussionMessages">
                                            <!-- 消息将通过JavaScript动态加载 -->
                                            <div class="text-center text-muted">Loading messages...</div>
                                        </div>
                                        
                                        <!-- 发布消息表单 -->
                                        <form id="discussionForm">
                                            <div class="mb-3">
                                                <label for="hunterId" class="form-label">User ID</label>
                                                <input type="text" class="form-control" id="hunterId" value="User" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="messageContent" class="form-label">Message</label>
                                                <textarea class="form-control" id="messageContent" rows="3" required></textarea>
                                            </div>
                                            <button type="submit" class="btn btn-primary">Post Message</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 猎人标签 -->
                    <div class="tab-pane fade" id="hunters" role="tabpanel" aria-labelledby="hunters-tab">
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">Hunters</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="huntersContent">
                                            <div class="text-center text-muted">Loading hunters...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 任务标签 -->
                    <div class="tab-pane fade" id="tasks" role="tabpanel" aria-labelledby="tasks-tab">
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">Tasks</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="tasksContent">
                                            <div class="text-center text-muted">Loading tasks...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 知识标签 -->
                    <div class="tab-pane fade" id="knowledge" role="tabpanel" aria-labelledby="knowledge-tab">
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">Knowledge</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="knowledgeContent">
                                            <div class="text-center text-muted">Loading knowledge...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 报告标签 -->
                    <div class="tab-pane fade" id="reports" role="tabpanel" aria-labelledby="reports-tab">
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">Reports</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="reportsContent">
                                            <div class="text-center text-muted">Loading reports...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- 自定义JavaScript -->
    <script>
        // 获取URL参数
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(window.location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // 设置命名空间
        function setNamespace(namespace) {
            const url = new URL(window.location);
            url.searchParams.set('namespace', namespace);
            window.location.href = url.toString();
        }

        // 获取当前命名空间
        function getCurrentNamespace() {
            return getUrlParameter('namespace') || 'default';
        }

        // 获取API URL
        function getApiUrl(endpoint) {
            const namespace = getCurrentNamespace();
            return `/api${endpoint}?namespace=${namespace}`;
        }

        // 获取所有命名空间
        async function fetchNamespaces() {
            try {
                const response = await fetch('/api/namespaces');
                const namespaces = await response.json();
                
                const menu = document.getElementById('namespaceMenu');
                menu.innerHTML = '';
                
                namespaces.forEach(ns => {
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.className = 'dropdown-item';
                    a.href = '#';
                    a.textContent = ns;
                    a.onclick = () => setNamespace(ns);
                    li.appendChild(a);
                    menu.appendChild(li);
                });
                
                // 更新当前命名空间显示
                document.getElementById('currentNamespace').textContent = getCurrentNamespace();
            } catch (error) {
                console.error('Error fetching namespaces:', error);
            }
        }

        // 获取讨论消息
        async function fetchDiscussionMessages() {
            try {
                const response = await fetch(getApiUrl('/discussion'));
                const data = await response.json();
                
                const container = document.getElementById('discussionMessages');
                if (data.messages && data.messages.length > 0) {
                    container.innerHTML = data.messages.map(msg => `
                        <div class="message">
                            <div class="message-header">${msg.hunter_id}</div>
                            <div class="message-time">${new Date(msg.created_at).toLocaleString()}</div>
                            <div class="message-content">${msg.content}</div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="text-center text-muted">No messages yet.</div>';
                }
            } catch (error) {
                console.error('Error fetching discussion messages:', error);
                document.getElementById('discussionMessages').innerHTML = '<div class="text-center text-danger">Error loading messages.</div>';
            }
        }

        // 发布讨论消息
        async function postDiscussionMessage(hunterId, content) {
            try {
                const response = await fetch(getApiUrl('/discussion'), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        hunter_id: hunterId,
                        content: content
                    })
                });
                
                if (response.ok) {
                    // 清空表单
                    document.getElementById('hunterId').value = '';
                    document.getElementById('messageContent').value = '';
                    
                    // 刷新消息列表
                    fetchDiscussionMessages();
                } else {
                    alert('Error posting message');
                }
            } catch (error) {
                console.error('Error posting message:', error);
                alert('Error posting message');
            }
        }

        // 获取猎人数据
        async function fetchHunters() {
            try {
                const response = await fetch(getApiUrl('/hunters'));
                const data = await response.json();
                
                const container = document.getElementById('huntersContent');
                if (data.hunters && data.hunters.length > 0) {
                    container.innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Skills</th>
                                        <th>Reputation</th>
                                        <th>Completed Tasks</th>
                                        <th>Failed Tasks</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.hunters.map(hunter => `
                                        <tr id="hunter-${hunter.id}">
                                            <td>${hunter.id.substring(0, 8)}...</td>
                                            <td>${Object.keys(hunter.skills).join(', ')}</td>
                                            <td>${hunter.reputation}</td>
                                            <td>${hunter.completed_tasks}</td>
                                            <td>${hunter.failed_tasks}</td>
                                            <td>
                                                <button class="btn btn-sm btn-danger delete-hunter-btn" data-hunter-id="${hunter.id}">
                                                    Delete
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    // 为删除按钮添加事件监听器
                    document.querySelectorAll('.delete-hunter-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            const hunterId = this.getAttribute('data-hunter-id');
                            if (confirm(`Are you sure you want to delete hunter ${hunterId.substring(0, 8)}?`)) {
                                deleteHunter(hunterId);
                            }
                        });
                    });
                } else {
                    container.innerHTML = '<div class="text-center text-muted">No hunters found.</div>';
                }
            } catch (error) {
                console.error('Error fetching hunters:', error);
                document.getElementById('huntersContent').innerHTML = '<div class="text-center text-danger">Error loading hunters.</div>';
            }
        }

        // 获取任务数据
        async function fetchTasks() {
            try {
                const response = await fetch(getApiUrl('/tasks'));
                const data = await response.json();
                
                const container = document.getElementById('tasksContent');
                if (data.tasks && data.tasks.length > 0) {
                    container.innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Required Skill</th>
                                        <th>Status</th>
                                        <th>Priority</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.tasks.map(task => `
                                        <tr id="task-${task.id}">
                                            <td>${task.id.substring(0, 8)}...</td>
                                            <td>${task.name}</td>
                                            <td>${task.required_skill}</td>
                                            <td>${task.status}</td>
                                            <td>${task.priority}</td>
                                            <td>${new Date(task.created_at).toLocaleDateString()}</td>
                                            <td>
                                                <button class="btn btn-sm btn-danger delete-task-btn" data-task-id="${task.id}">
                                                    Delete
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    // 为删除按钮添加事件监听器
                    document.querySelectorAll('.delete-task-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            const taskId = this.getAttribute('data-task-id');
                            if (confirm(`Are you sure you want to delete task ${taskId.substring(0, 8)}?`)) {
                                deleteTask(taskId);
                            }
                        });
                    });
                } else {
                    container.innerHTML = '<div class="text-center text-muted">No tasks found.</div>';
                }
            } catch (error) {
                console.error('Error fetching tasks:', error);
                document.getElementById('tasksContent').innerHTML = '<div class="text-center text-danger">Error loading tasks.</div>';
            }
        }

        // 获取知识数据
        async function fetchKnowledge() {
            try {
                const response = await fetch(getApiUrl('/knowledge'));
                const data = await response.json();
                
                const container = document.getElementById('knowledgeContent');
                if (data.knowledge && data.knowledge.length > 0) {
                    container.innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Title</th>
                                        <th>Skill Tags</th>
                                        <th>Source</th>
                                        <th>Created By</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.knowledge.map(item => `
                                        <tr id="knowledge-${item.id}">
                                            <td>${item.id.substring(0, 8)}...</td>
                                            <td>${item.title}</td>
                                            <td>${item.skill_tags.join(', ')}</td>
                                            <td>${item.source}</td>
                                            <td>${item.created_by}</td>
                                            <td>
                                                <button class="btn btn-sm btn-danger delete-knowledge-btn" data-knowledge-id="${item.id}">
                                                    Delete
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    // 为删除按钮添加事件监听器
                    document.querySelectorAll('.delete-knowledge-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            const knowledgeId = this.getAttribute('data-knowledge-id');
                            if (confirm(`Are you sure you want to delete knowledge item ${knowledgeId.substring(0, 8)}?`)) {
                                deleteKnowledge(knowledgeId);
                            }
                        });
                    });
                } else {
                    container.innerHTML = '<div class="text-center text-muted">No knowledge items found.</div>';
                }
            } catch (error) {
                console.error('Error fetching knowledge:', error);
                document.getElementById('knowledgeContent').innerHTML = '<div class="text-center text-danger">Error loading knowledge.</div>';
            }
        }

        // 获取报告数据
        async function fetchReports() {
            try {
                const response = await fetch(getApiUrl('/reports'));
                const data = await response.json();
                
                const container = document.getElementById('reportsContent');
                if (data.reports && data.reports.length > 0) {
                    container.innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Task ID</th>
                                        <th>Hunter ID</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.reports.map(report => `
                                        <tr id="report-${report.id}">
                                            <td>${report.id.substring(0, 8)}...</td>
                                            <td>${report.task_id.substring(0, 8)}...</td>
                                            <td>${report.hunter_id.substring(0, 8)}...</td>
                                            <td>${report.status}</td>
                                            <td>${new Date(report.created_at).toLocaleDateString()}</td>
                                            <td>
                                                <button class="btn btn-sm btn-danger delete-report-btn" data-report-id="${report.id}">
                                                    Delete
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    // 为删除按钮添加事件监听器
                    document.querySelectorAll('.delete-report-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            const reportId = this.getAttribute('data-report-id');
                            if (confirm(`Are you sure you want to delete report ${reportId.substring(0, 8)}?`)) {
                                deleteReport(reportId);
                            }
                        });
                    });
                } else {
                    container.innerHTML = '<div class="text-center text-muted">No reports found.</div>';
                }
            } catch (error) {
                console.error('Error fetching reports:', error);
                document.getElementById('reportsContent').innerHTML = '<div class="text-center text-danger">Error loading reports.</div>';
            }
        }

        // 删除任务
        async function deleteTask(taskId) {
            try {
                const response = await fetch(getApiUrl(`/tasks/${taskId}/delete`), {
                    method: 'POST'
                });
                
                if (response.ok) {
                    // 从DOM中移除任务行
                    const taskRow = document.getElementById(`task-${taskId}`);
                    if (taskRow) {
                        taskRow.remove();
                    }
                    alert('Task deleted successfully');
                } else {
                    alert('Error deleting task');
                }
            } catch (error) {
                console.error('Error deleting task:', error);
                alert('Error deleting task');
            }
        }
        
        // 删除猎人
        async function deleteHunter(hunterId) {
            try {
                const response = await fetch(getApiUrl(`/hunters/${hunterId}/delete`), {
                    method: 'POST'
                });
                
                if (response.ok) {
                    // 从DOM中移除猎人行
                    const hunterRow = document.getElementById(`hunter-${hunterId}`);
                    if (hunterRow) {
                        hunterRow.remove();
                    }
                    alert('Hunter deleted successfully');
                } else {
                    alert('Error deleting hunter');
                }
            } catch (error) {
                console.error('Error deleting hunter:', error);
                alert('Error deleting hunter');
            }
        }
        
        // 删除知识条目
        async function deleteKnowledge(knowledgeId) {
            try {
                const response = await fetch(getApiUrl(`/knowledge/${knowledgeId}/delete`), {
                    method: 'POST'
                });
                
                if (response.ok) {
                    // 从DOM中移除知识行
                    const knowledgeRow = document.getElementById(`knowledge-${knowledgeId}`);
                    if (knowledgeRow) {
                        knowledgeRow.remove();
                    }
                    alert('Knowledge item deleted successfully');
                } else {
                    alert('Error deleting knowledge item');
                }
            } catch (error) {
                console.error('Error deleting knowledge:', error);
                alert('Error deleting knowledge item');
            }
        }
        
        // 删除报告
        async function deleteReport(reportId) {
            try {
                const response = await fetch(getApiUrl(`/reports/${reportId}/delete`), {
                    method: 'POST'
                });
                
                if (response.ok) {
                    // 从DOM中移除报告行
                    const reportRow = document.getElementById(`report-${reportId}`);
                    if (reportRow) {
                        reportRow.remove();
                    }
                    alert('Report deleted successfully');
                } else {
                    alert('Error deleting report');
                }
            } catch (error) {
                console.error('Error deleting report:', error);
                alert('Error deleting report');
            }
        }
        
        // 删除所有猎人
        async function deleteAllHunters() {
            try {
                const response = await fetch(getApiUrl('/hunters'), {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('All hunters deleted successfully');
                } else {
                    alert('Error deleting hunters');
                }
            } catch (error) {
                console.error('Error deleting hunters:', error);
                alert('Error deleting hunters');
            }
        }
        
        // 删除所有任务
        async function deleteAllTasks() {
            try {
                const response = await fetch(getApiUrl('/tasks'), {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('All tasks deleted successfully');
                    // 刷新任务列表
                    fetchTasks();
                } else {
                    alert('Error deleting tasks');
                }
            } catch (error) {
                console.error('Error deleting tasks:', error);
                alert('Error deleting tasks');
            }
        }
        
        // 删除所有知识
        async function deleteAllKnowledge() {
            try {
                const response = await fetch(getApiUrl('/knowledge'), {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('All knowledge deleted successfully');
                    // 刷新知识列表
                    fetchKnowledge();
                } else {
                    alert('Error deleting knowledge');
                }
            } catch (error) {
                console.error('Error deleting knowledge:', error);
                alert('Error deleting knowledge');
            }
        }
        
        // 删除所有报告
        async function deleteAllReports() {
            try {
                const response = await fetch(getApiUrl('/reports'), {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('All reports deleted successfully');
                    // 刷新报告列表
                    fetchReports();
                } else {
                    alert('Error deleting reports');
                }
            } catch (error) {
                console.error('Error deleting reports:', error);
                alert('Error deleting reports');
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 设置当前命名空间
            document.getElementById('currentNamespace').textContent = getCurrentNamespace();
            
            // 获取命名空间列表
            fetchNamespaces();
            
            // 获取讨论消息
            fetchDiscussionMessages();
            
            // 设置讨论表单提交事件
            document.getElementById('discussionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const hunterId = document.getElementById('hunterId').value;
                const content = document.getElementById('messageContent').value;
                if (hunterId && content) {
                    postDiscussionMessage(hunterId, content);
                }
            });
            
            
            // 设置标签页切换事件
            document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function(e) {
                    const target = e.target.getAttribute('aria-controls');
                    switch(target) {
                        case 'hunters':
                            fetchHunters();
                            break;
                        case 'tasks':
                            fetchTasks();
                            break;
                        case 'knowledge':
                            fetchKnowledge();
                            break;
                        case 'reports':
                            fetchReports();
                            break;
                    }
                });
            });
        });
    </script>
</body>
</html>